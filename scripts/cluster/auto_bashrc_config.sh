#!/bin/bash

# ====================================================================
# 脚本名称: sync_bashrc_from_file.sh
# 功能: 从文件中读取节点列表，自动同步本地的 .bashrc 文件到这些节点
# 使用方法: ./sync_bashrc_from_file.sh /path/to/your/node_list.txt
# 
# 前提: 
# 1. 确保你已配置了 SSH 无密码登录，或者你将能够手动输入密码。
# 2. 节点列表文件中的每一行应包含一个节点地址，例如: user@node1
# ====================================================================

# --------------------------------------------------------------------
# 1. 变量和参数检查
# --------------------------------------------------------------------
# 检查命令行参数，确保节点文件路径已提供
if [ -z "$1" ]; then
    echo "使用方法: $0 <节点文件路径>"
    echo "示例: $0 nodes.txt"
    exit 1
fi

NODE_LIST_FILE="$1"

# 检查节点列表文件是否存在
if [ ! -f "$NODE_LIST_FILE" ]; then
    echo "错误: 节点列表文件 '$NODE_LIST_FILE' 未找到。"
    exit 1
fi


# 从文件读取节点列表到数组 (使用 < "$VAR" 语法，并忽略空行和注释行)
mapfile -t NODE_HOSTS < <(grep -v -e '^\s*$' -e '^\s*#' "$NODE_LIST_FILE")

# 检查节点列表是否为空
if [ ${#NODE_HOSTS[@]} -eq 0 ]; then
    echo "❌ 错误: 节点列表 '$NODE_LIST_FILE' 为空。"
    exit 1
fi

# 要同步的本地文件
LOCAL_FILE="$HOME/.bashrc"
# 远程文件路径
REMOTE_FILE="$HOME/.bashrc"

# 检查本地 .bashrc 文件是否存在
if [ ! -f "$LOCAL_FILE" ]; then
    echo "错误: 本地文件 '$LOCAL_FILE' 未找到。"
    exit 1
fi

# --------------------------------------------------------------------
# 2. 同步过程
# --------------------------------------------------------------------

echo "开始从文件 '$NODE_LIST_FILE' 同步 '$LOCAL_FILE' 到以下节点..."
echo "-------------------------------------"

# 逐行读取文件并同步
for node in "${NODE_HOSTS[@]}"; do
    
    echo "正在同步到节点: $node ..."
    
    # 使用 scp 命令复制文件
    # -p 参数用于保留文件的修改时间和权限
    # -q 参数用于静默模式，减少输出
    scp -p "$LOCAL_FILE" "$node:$REMOTE_FILE"
    
    # 检查 scp 命令是否成功执行
    if [ $? -eq 0 ]; then
        echo "✅ 同步成功!"
    else
        echo "❌ 同步失败。请检查网络连接、节点名或 SSH 权限。"
    fi
    echo "-------------------------------------"
done

echo "所有节点同步任务完成。"
echo "提示: 在每个节点上，你可能需要运行 'source ~/.bashrc' 来使更改生效。"